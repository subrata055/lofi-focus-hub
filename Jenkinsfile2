pipeline {
    agent any
    
    environment {
        // Explicitly set the project name to avoid Bash/Groovy syntax conflicts
        COMPOSE_PROJECT_NAME = "lofi-focus-hub"
        COMPOSE_FILE = "docker-compose.yml"
        DOCKERHUB_CREDENTIALS = credentials('dockerhub-credentials')
        DOCKERHUB_USERNAME = 'subrata055'
        IMAGE_NAME = 'lofi-focus-hub'
        IMAGE_TAG = "${BUILD_NUMBER}"
    }
    
    stages {
        stage('Verify') {
            steps {
                sh '''
                    docker version
                    docker compose version
                '''
            }
        }
        
        stage('Build') {
            steps {
                // FIX 1: Use 'docker compose' (no hyphen) for V2
                sh 'docker compose build'
                
                // FIX 2: Fixed the variable interpolation. 
                // Based on your logs, Docker V2 names images with hyphens, not underscores.
                // We use the explicit COMPOSE_PROJECT_NAME variable defined above.
                sh "docker tag ${COMPOSE_PROJECT_NAME}-${IMAGE_NAME}:latest ${DOCKERHUB_USERNAME}/${IMAGE_NAME}:${IMAGE_TAG}"
                sh "docker tag ${COMPOSE_PROJECT_NAME}-${IMAGE_NAME}:latest ${DOCKERHUB_USERNAME}/${IMAGE_NAME}:latest"
            }
        }
        
        stage('Login to DockerHub') {
            steps {
                sh 'echo $DOCKERHUB_CREDENTIALS_PSW | docker login -u $DOCKERHUB_CREDENTIALS_USR --password-stdin'
            }
        }
        
        stage('Push to DockerHub') {
            steps {
                sh "docker push ${DOCKERHUB_USERNAME}/${IMAGE_NAME}:${IMAGE_TAG}"
                sh "docker push ${DOCKERHUB_USERNAME}/${IMAGE_NAME}:latest"
            }
        }
        
        stage('Deploy') {
            steps {
                // FIX 3: Pass UID/GID so the container runs as the 'jenkins' user.
                // This prevents files created in the volume (like your DB) from being owned by root.
                sh "docker compose down"
                sh "UID=\$(id -u) GID=\$(id -g) docker compose up -d"
            }
        }
    }
    
    post {
        always {
            sh 'docker logout'
            cleanWs()
        }
        success {
            echo "Lo-Fi Focus Hub deployed successfully!"
        }
        failure {
            echo 'Pipeline failed. Check logs for details.'
        }
    }
}